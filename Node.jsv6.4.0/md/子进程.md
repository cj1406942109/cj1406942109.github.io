# Node.js v6.4.0文档


<!-- toc orderedList:0 -->

- [Node.js v6.4.0文档](#nodejs-v640文档)
- [子进程](#子进程)
	- [异步进程创建](#异步进程创建)
		- [windows下生成.bat和.cmd文件](#windows下生成bat和cmd文件)
		- [`child_process.exec(command[, options][, callback])`](#child_processexeccommand-options-callback)
		- [`child_process.execFile(file[, args][, options][, callback])`](#child_processexecfilefile-args-options-callback)
		- [`child_process.fork(modulePath[, args][, options])`](#child_processforkmodulepath-args-options)
		- [`child_process.spawn(command[,args][,options])`](#child_processspawncommandargsoptions)
			- [`options.detached`](#optionsdetached)
			- [`option.stdio`](#optionstdio)
	- [同步进程创建](#同步进程创建)
		- [`child_process.execFileSync(file[, args][, options])`](#child_processexecfilesyncfile-args-options)
		- [`child_process.execSync(command[, options])`](#child_processexecsynccommand-options)
		- [`child_process.spawnSync(command[, args][, options])`](#child_processspawnsynccommand-args-options)
	- [类：`ChildProcess`](#类childprocess)
		- [事件：`'disconnect'`](#事件disconnect)
		- [事件：`'error'`](#事件error)
		- [事件：`'exit'`](#事件exit)
		- [事件：`'message'`](#事件message)
		- [`child.connected`](#childconnected)
		- [`child.disconnect()`](#childdisconnect)
		- [`child.kill([signal])`](#childkillsignal)

<!-- tocstop -->

# 子进程
> **稳定性：2 - 稳定**

`child_process`模块提供生成子进程的能力，在某种意义上，它与[popen(3)](http://man7.org/linux/man-pages/man3/popen.3.html)类似，但是不完全相同。该能力主要由[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)函数提供：

```js
const spawn = require('child_process').spawn;
const ls = spawn('ls', ['-lh', '/usr']);

ls.stdout.on('data', (data) => {
  console.log(`stdout: ${data}`);
});

ls.stderr.on('data', (data) => {
  console.log(`stderr: ${data}`);
});

ls.on('close', (code) => {
  console.log(`child process exited with code ${code}`);
});
```

默认情况下，`stdin`、`stdout`和`stderr`的管道建立在父级Node.js进程和生成的子进程之间。可以在这些管道中进行无阻塞数据流传输。但是要注意：一些程序内部使用`line-buffered I/O`，尽管这对Node.js没有影响，但是传递给子进程的数据可能不会立即被接收。

[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)函数异步生成子进程，不会阻塞Node.js的事件循环。[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)函数以同步的方式提供等价的功能，它会阻塞事件循环，直到生成的子进程退出或者被终止。

为了方便，`child_process`模块针对[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)和[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)提供了一部分同步和异步的替代品。注意：这些替代品都是在[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)和[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)之上实现的。

- [child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)：生成一个命令解析器（shell)并在其中运行命令，完成时将`stdout`和`stderr`传递给回调函数。
- [child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)：与[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)相同，除了它是直接产生命令而没有先产生一个shell。
- [child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)：生成一个新的Node.js进程并调用一个特定的模块，同时建立一个IPC（进程间通信）通信通道，允许父进程和子进程之间发送消息。
- [child_process.execSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execsync_command_options)：[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)的同步版本，会阻塞Node.js的事件循环。
- [child_process.execFileSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfilesync_file_args_options)：[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)的同步版本，会阻塞Node.js的事件循环。

对于特定的使用案例，如自动shell脚本，[同步版方法](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_synchronous_process_creation)可能会更方便。但是，大多数情况下，同步方法会对性能有很大的影响，因为在生成子进程的时候停止了事件循环。

## 异步进程创建

[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)，[child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)，[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)和[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)都遵循其他典型Node.jsAPI的惯用异步编程模式。

每个方法返回一个[子进程](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process)实例。这些对象实现了Node.js的[事件触发器](https://nodejs.org/dist/latest-v6.x/docs/api/events.html#events_class_eventemitter)API，允许父进程注册监听器函数，当特定的事件在子进程的生命周期中发生时函数被调用。

[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)和[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)方法都允许指定一个可选的回调函数，当子进程终止时调用。

### windows下生成.bat和.cmd文件

[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)和[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)之间的差别可能基于平台而不同。在Unix类操作系统（Unix、Linux、OSX）上，[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)可能会更高效，因为它不产生一个shell。但是，在windows上，没有终端，`.bat`文件和`.cmd`文件是不能自执行的，因此，不能使用[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)启动。在windows下运行时，可以通过`shell`选项集、[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)或者通过生成`cmd.exe`并将`.bat`或`.cmd`文件作为参数（这就是`shell`选项和[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)做的工作）来使用[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)调用`.bat`和`.cmd`文件。

```js
// On Windows Only ...
const spawn = require('child_process').spawn;
const bat = spawn('cmd.exe', ['/c', 'my.bat']);

bat.stdout.on('data', (data) => {
  console.log(data);
});

bat.stderr.on('data', (data) => {
  console.log(data);
});

bat.on('exit', (code) => {
  console.log(`Child exited with code ${code}`);
});

// OR...
const exec = require('child_process').exec;
exec('my.bat', (err, stdout, stderr) => {
  if (err) {
    console.error(err);
    return;
  }
  console.log(stdout);
});
```

### `child_process.exec(command[, options][, callback])`
添加于v0.1.90
- `command`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要运行的命令使用空格分隔参数
- `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `encoding`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，默认：`'utf8'`
    - `shell`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，执行命令的shell，默认：Unix下为`/bin/sh`，Windows下为`cmd.exe`，shell需要理解Uninx下的`-c`转换或者Windows下的/s/c`。
    - `timeout`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，默认：0
    - [maxBuffer](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_maxbuffer_and_unicode)[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，stdout或stderr允许传输的最大数据量（单位：字节），如果超出，子进程会被杀死（默认：200*1024）。
    - `killSignal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，默认：`SIGTERM`。
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
- `callback`[\<Function>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function)，进程终止时由输出调用
    - `error`[\<Error>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)
    - `stdout`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)
    - `stderr`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)
- 返回值：[\<ChildProcess>](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_class_childprocess)

生成一个shell，然后用该shell执行命令，缓冲生成的输出。

```js
const exec = require('child_process').exec;
exec('cat *.js bad_file | wc -l', (error, stdout, stderr) => {
  if (error) {
    console.error(`exec error: ${error}`);
    return;
  }
  console.log(`stdout: ${stdout}`);
  console.log(`stderr: ${stderr}`);
});
```

如果提供了回调函数，它会以参数`(error,stdout,stderr)`被调用。如果成功，`error`为`null`，如果失败，`error`为[Error](https://nodejs.org/dist/latest-v6.x/docs/api/errors.html#errors_class_error)的一个实例。`error.code`属性为子进程的退出码，而`error.signal`会被设置为终止进程的信号。0以为的其他退出码都被视为错误。

传递给回调函数的`stdout`和`stderr`参数包含子进程的`stdout`和`stderr`输出。默认情况下，Node.js会将输出按utf8进行解码并将string 传递给回调函数。可以使用`encoding`选项指定编码字符来对`stdout`和`stderr`输出进行解码。如果`encoding`值为`buffer`，或者未识别的字符，则将`Buffer`对象传递给回调函数。

`option`参数可以作为第二个参数传入，用于自定义如何生成进程。默认选项如下：
```js
{
  encoding: 'utf8',
  timeout: 0,
  maxBuffer: 200*1024,
  killSignal: 'SIGTERM',
  cwd: null,
  env: null
}
```
如果`timeout`大于`0`，当子进程的运行时间超过`timeout`毫秒时，父进程就会通过`killSignal`属性（默认为`'SIGTERM'`）发送信号标识。

注意：与[exec(3)](http://man7.org/linux/man-pages/man3/exec.3.html)POSIX系统调用不同，`child_process.exec()`不会替换已经存在的进程并使用shell来执行命令。

### `child_process.execFile(file[, args][, options][, callback])`
添加于v0.1.91
- `file` [\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，可执行文件的文件名或路径
- `args`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，字符参数列表
- `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `encoding`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，默认：`'utf8'`
    - `timeout`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，默认：0
    - [maxBuffer](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_maxbuffer_and_unicode)[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，stdout或stderr允许传输的最大数据量（单位：字节），如果超出，子进程会被杀死（默认：200*1024）。
    - `killSignal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，默认：`SIGTERM`。
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
- `callback`[\<Function>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function)，进程终止时由输出调用
    - `error`[\<Error>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)
    - `stdout`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)
    - `stderr`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)
- 返回值：[\<ChildProcess>](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_class_childprocess)

除了不产生shell，`child_process.execFile()`函数与[`child_process.exec()`](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)相同。相反，指定的可执行文件`file`直接作为新的子进程产生使得它稍比[`child_process.exec()`](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)更加高效。

`option`参数与[`child_process.exec()`](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)相同。因为不产生shell，所以不支持像I/O重定向和文件扩展匹配等行为。

```js
const execFile = require('child_process').execFile;
const child = execFile('node', ['--version'], (error, stdout, stderr) => {
  if (error) {
    throw error;
  }
  console.log(stdout);
});
```

传递给回调函数的`stdout`和`stderr`参数会包含子进程的`stdout`和`stderr`输出。默认情况下，Node.js会将输出按utf8进行解码并将string 传递给回调函数。可以使用`encoding`选项指定编码字符来对`stdout`和`stderr`输出进行解码。如果`encoding`值为`buffer`，或者未识别的字符，则将`Buffer`对象传递给回调函数。

### `child_process.fork(modulePath[, args][, options])`
添加于v0.5.0
- `modulaPath`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要在子进程中运行的模块
- `args`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，字符参数列表
- `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `execPath`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，用于创建子进程的执行档
    - `execArgv`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，传递给执行档的字符参数列表（默认：`process.execArgv`）
    - `silent`[\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)，如果为`true`，子进程的`stdin`、`stdout`和`stderr`会传输到父进程，否则它们将继承父进程，查看[ child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)的[stdio](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_stdio)的`pipe`和`inherit`选项获取更多信息（默认：false）
    - `stdio` [\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，支持[ child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)的[stdio](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_stdio)的数组版本，当提供了该选项，它将会覆盖`silent`。
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
- 返回值：[\<ChildProcess>](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_class_childprocess)

`child_process.fork()`方法是[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)的一个特例，用于产生新的Node.js进程。与[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)类似，返回一个[子进程](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process)对象。返回的子进程对象有内置的附加通信通道，允许消息在子进程与父进程之间进行来回传递。查看[child.send()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_send_message_sendhandle_options_callback)获取详情。

除了IPC通信通道建立于两者之间，产生的Node.js子进程是独立于父进程的。每个进程都拥有自己的内存，使用自己的V8实例。由于需要额外的资源分配，不推荐产生大量的Node.js子进程。

默认情况下，`child_process.fork()`会使用父进程的[process.execPath](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_execpath)产生新的Node.js实例。`option`对象的`execPath`属性允许使用一个可选的执行路径。

自定义`execPaht`运行的Node.js进程会使用由子进程上的环境变量`NODE_CHANNEL_FD`来鉴定的文件描述符(fd)与父进程交流。文件描述符上的输入和输出为行分割JSON对象。

注意：与[fork(2)](http://man7.org/linux/man-pages/man2/fork.2.html)POSIX系统调用不同，`child_process.fork()`不复制当前进程。

### `child_process.spawn(command[,args][,options])`
添加于v0.1.90
- `command`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要运行的命令
- `args`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，字符参数列表
-  `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `arg0`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，显示设置传递给子进程的`argv[0]`的值。如果未指定，该值将被设置为`command`
    - `stdio` [\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的标准输入输出配置。（查看[options.stdio](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_stdio)）
    - `detached`[\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)，为子进程独立于它的父进程运行做准备。特定行为依赖于平台（查看[options.detached](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_detached)）
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
    - `shell`[\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，如果为`true`，则在shell中运行`command`。在UNIX下使用`'/bin/sh'`，Windows下使用`'cmd.exe'`。可以使用字符串指定其他shell。该shell需要理解UNIX下的`-c`转换，或Windows下的`/s/c`。默认为`false`（没有shell）
- 返回值：[\<ChildProcess>](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_class_childprocess)

`child_process.spawn()`方法产生一个使用指定`command`的新进程，其命令行参数在`args`中。如果省略，`args`默认为空数组。

可以使用第三个参数来指定额外的选项，默认为：
```js
{
  cwd: undefined,
  env: process.env
}
```

使用`cwd`来指定产生的进程的工作目录，如果未指定，默认继承当前工作目录。

使用`env`来指定新进程可见的环境变量，默认为[process.env](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_env)。

案例：运行`ls -lh/usr`，捕获`stdout`,`stderr`和退出码的：
```js
const spawn = require('child_process').spawn;
const ls = spawn('ls', ['-lh', '/usr']);

ls.stdout.on('data', (data) => {
  console.log(`stdout: ${data}`);
});

ls.stderr.on('data', (data) => {
  console.log(`stderr: ${data}`);
});

ls.on('close', (code) => {
  console.log(`child process exited with code ${code}`);
});
```

案例：以非常详尽的方式运行`ps ax | grep ssh`
```js
const spawn = require('child_process').spawn;
const ps = spawn('ps', ['ax']);
const grep = spawn('grep', ['ssh']);

ps.stdout.on('data', (data) => {
  grep.stdin.write(data);
});

ps.stderr.on('data', (data) => {
  console.log(`ps stderr: ${data}`);
});

ps.on('close', (code) => {
  if (code !== 0) {
    console.log(`ps process exited with code ${code}`);
  }
  grep.stdin.end();
});

grep.stdout.on('data', (data) => {
  console.log(`${data}`);
});

grep.stderr.on('data', (data) => {
  console.log(`grep stderr: ${data}`);
});

grep.on('close', (code) => {
  if (code !== 0) {
    console.log(`grep process exited with code ${code}`);
  }
});
```

案例：检查失败的执行程序：
```js
const spawn = require('child_process').spawn;
const child = spawn('bad_command');

child.on('error', (err) => {
  console.log('Failed to start child process.');
});
```

注意：某些平台（OS X，Linux）使用`argv[0]`的值作为进程标题，而另一些平台（Windows，SunOS）使用`command`。

注意：Node.js一般在启动时用`process.execPath`覆盖`argv[0]`，因此子进程中的`process.argv[0]`不会与传递给父进程用于产生新进程的`argv0`参数相匹配，用`process.argv0`属性替代来重新获取它。

#### `options.detached`
添加于v0.7.10

Windows下，将`options.detached`设置为`ture`，使得子进程在父进程退出后还能继续运行。子进程拥有自己的控制台窗口。*一旦为子进程启用，将不能关闭。*

在无窗口平台下，如果`options.detached`设置为`true`，子进程将领导一个新的进程组和会话。注意，子进程在父进程退出后会继续运行，而不管它们是否分离。查看[setsid(2)](http://man7.org/linux/man-pages/man2/setsid.2.html)获取更多信息。

默认情况下，父进程会等待分离的子进程退出。为了阻止父进程等待一个给定的子进程，可以使用`child.unref()`方法。这样做会导致父进程的事件循环不将子进程包括在它的参考计数中，允许父进程独立于子进程退出，除非父进程与子进程之间建立了IPC通道。

当使用`detached`选项启动一个长时间运行的进程，该进程在父进程退出后不会继续在后台运行，除非提供了`stdio`配置，其不与父进程相连接。如果是继承父进程的`stdio`，子进程会保持连接到控制终端。

案例：一个长时间运行的进程，通过分离并忽略其父进程的`stdio`文件描述符，来忽略父进程的终止。
```js
const spawn = require('child_process').spawn;

const child = spawn(process.argv[0], ['child_program.js'], {
  detached: true,
  stdio: 'ignore'
});

child.unref();
```

可以重定向子进程的输出到文件：
```js
const fs = require('fs');
const spawn = require('child_process').spawn;
const out = fs.openSync('./out.log', 'a');
const err = fs.openSync('./out.log', 'a');

const child = spawn('prg', [], {
 detached: true,
 stdio: [ 'ignore', out, err ]
});

child.unref();
```

#### `option.stdio`
添加于v0.7.10

`options.stdio`选项用于配置建立于父进程和子进程之间的传输管道。默认情况下，子进程的stdin，stdout和stderr都被重定向到对应的子进程对象的[child.stdin](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stdin)，[child.stdout](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stdout)和[child.stderr](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stderr)流。这与将`options.stdio`设置为`['pipe','pipe','pipe']`等价。

为了方便起见，`options.stdio`可以是下列字符串中的任一个：
- `'pipe'`- 与`['pipe','pipe','pipe']`等价（默认值）
- `ignore`- 与`['ignore','ignore','ignore']`等价
- `inherit`- 与`['process.stdin','process.stdout','process.stderr']`或`[0,1,2]`等价

否则，`options.stdio`的值是一个数组，其每个索引对应子进程中的一个文件标识符。文件描述符0,1,2分别对应`stdin`，`stdout`和`stderr`。可以指定附加的文件标识符来创建父进程和子进程之间的附加传输通道。其值是下列中的任一个：
1. `pipe`- 在父进程和子进程之间创建一个通道。管道的父进程端暴露给父进程作为`child_process`对象的一个属性[child.stdio\[fd\]](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_stdio)。为fds 0 到2 创建的传输管道对于[child.stdin](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stdin)，[stdout](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stdout)和[stderr](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_stderr)同样可用
2. `ipc`- 创建一个IPC通道用于在父进程和子进程之间传递消息或文件描述符。一个[子进程](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process)最多可以有一个IPC标准输入输出文件标识符。设置这个选项使[child.send()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_send_message_sendhandle_options_callback)方法可用。如果子进程将JSON消息写入该文件标识符，父进程上的[`child.on('message')`](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_event_message)事件处理器会被触发。如果子进程是一个Node.js进程，IPC通道的存在会使得子进程中的[`process.send()`](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_send_message_sendhandle_options_callback)、[`process.on('disconnect')`](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_disconnect)和[`process.on('message')`](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_message)方法可用。
3. `ignore`- 命令Node.js忽略子进程中的文件标识符。尽管Node.js通常会在进程产生时为其开放文件描述符0-2，但是将文件描述符设置为`ignore`会使得Node.js打开`/dev/null`并将其添加到子进程的文件描述符。
4. [\<Stream>](https://nodejs.org/dist/latest-v6.x/docs/api/stream.html#stream_stream)对象- 与子进程共享指向电传打印机、文件、套接字接口、或管道的可读或可写流。流的底层文件描述符在子进程中被复制到`stdio`数组中对应索引的文件描述符中。注意：流必须有一个底层的描述符（直到`open`事件发生，文件流才工作）。
5. 正整数- 整数值被解析为父进程中当前打开的文件描述符。它与子进程共享，与[\<Stream>](https://nodejs.org/dist/latest-v6.x/docs/api/stream.html#stream_stream)对象的共享方式类似。
6. `null`，`undefined`- 使用默认值。对于标准输入输出文件描述符0,1和2（即stdin，stdout和stderr），创建一个管道。对于文件描述符3及3以上，默认值为`ignore`。

例：
```js
const spawn = require('child_process').spawn;

// Child will use parent's stdios
spawn('prg', [], { stdio: 'inherit' });

// Spawn child sharing only stderr
spawn('prg', [], { stdio: ['pipe', 'pipe', process.stderr] });

// Open an extra fd=4, to interact with programs presenting a
// startd-style interface.
spawn('prg', [], { stdio: ['pipe', null, null, null, 'pipe'] });
```

值得注意的是当IPC通道在父进程和子进程之间建立，同时该子进程也是一个Node.js进程时，子进程启动时IPC通道未引用（使用`unref()`）直到子进程为[process.on('disconnect')](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_disconnect)事件注册一个事件处理器。这允许子进程在进程没有被开放的IPC通道悬挂开放的情况下正常退出。

另请参见[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)和[child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)


## 同步进程创建
[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)、[child_process.execSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execsync_command_options)和[child_process.execFileSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfilesync_file_args_options)方法是同步的，会阻塞Node.js的事件循环，暂停其他代码的执行，直到产生的进程退出。

像这样的阻塞调用对于简化通用脚本任务和简化应用启动时配置的加载和处理非常有用。

### `child_process.execFileSync(file[, args][, options])`
添加于v0.11.12
- `file`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要执行的文件名或路径
- `args`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，字符参数列表
-  `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `input`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)，作为标准输入传递给产生的进程的值
	    - 提供该值将会覆盖`stdio[0]`
    - `stdio`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，子进程的标准输入输出配置（默认：`'pipe'`）
	    - `stderr`默认会输出到父进程的stderr，除非指定了`stdio`
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
    - `timeout`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，进程允许运行的最大时间总数（单位：毫秒，默认：`undefined`）
	- `killSignal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要杀死产生的进程时使用的信号值（默认：`SIGTERM`）。
	- [maxBuffer](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_maxbuffer_and_unicode)[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，stdout或stderr允许传输的最大数据量（单位：字节），如果超出，子进程会被杀死。
	- `encoding`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，所有标准标准输入输出使用的编码方式（默认：`'buffer'`）。
- 返回值：[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，命令行的标准输出

`child_process.execFileSync()`方法与[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)大致相同，除了前者不会返回值直到子进程被完全关闭。当遇到超时，则会发送`killSignal`，该方法不会返回值直到进程完全退出。注意：如歌子进程拦截并处理`SIGTERM`信号并且不退出，父进程仍会等待直到子进程退出。

如果进程超时，或者有一个非0退出码，该方法会抛出错误。[Error](https://nodejs.org/dist/latest-v6.x/docs/api/errors.html#errors_class_error)对象会包含[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)的全部结果。

### `child_process.execSync(command[, options])`
添加于v0.11.12
- `command`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要运行的命令
-  `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `input`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)，作为标准输入传递给产生的进程的值
	    - 提供该值将会覆盖`stdio[0]`
    - `stdio`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，子进程的标准输入输出配置（默认：`'pipe'`）
	    - `stderr`默认会输出到父进程的stderr，除非指定了`stdio`
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    -  `shell`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，执行命令的shell，默认：Unix下为`/bin/sh`，Windows下为`cmd.exe`，shell需要理解Uninx下的`-c`转换或者Windows下的/s/c`。Windows下，命令行解析需要与`cmd.exe`兼容
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
    - `timeout`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，进程允许运行的最大时间总数（单位：毫秒，默认：`undefined`）
	- `killSignal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要杀死产生的进程时使用的信号值（默认：`SIGTERM`）。
	- [maxBuffer](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_maxbuffer_and_unicode)[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，stdout或stderr允许传输的最大数据量（单位：字节），如果超出，子进程会被杀死。
	- `encoding`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，所有标准标准输入输出使用的编码方式（默认：`'buffer'`）。
- 返回值：[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，命令行的标准输出


`child_process.execSync()`方法与[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)大致相同，除了前者不会返回值直到子进程被完全关闭。当遇到超时，则会发送`killSignal`，该方法不会返回值直到进程完全退出。注意：如歌子进程拦截并处理`SIGTERM`信号并且不退出，父进程仍会等待直到子进程退出。

如果进程超时，或者有一个非0退出码，该方法会抛出错误。[Error](https://nodejs.org/dist/latest-v6.x/docs/api/errors.html#errors_class_error)对象会包含[child_process.spawnSync()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawnsync_command_args_options)的全部结果。

### `child_process.spawnSync(command[, args][, options])`
添加于v0.11.12
- `command`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要运行的命令
-  `args`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，字符参数列表
-  `option`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
    - `cwd`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，子进程的当前工作目录
    - `input`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)，作为标准输入传递给产生的进程的值
	    - 提供该值将会覆盖`stdio[0]`
    - `stdio`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，子进程的标准输入输出配置
    - `env`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，环境键值对
    - `uid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的用户标识。（查看[setuid(2)](http://man7.org/linux/man-pages/man2/setuid.2.html)）
    - `gid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，设置进程的组标识。（查看[setgid(2)](http://man7.org/linux/man-pages/man2/setgid.2.html)）
    - `timeout`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，进程允许运行的最大时间总数（单位：毫秒，默认：`undefined`）
	- `killSignal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，要杀死产生的进程时使用的信号值（默认：`SIGTERM`）。
	- [maxBuffer](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_maxbuffer_and_unicode)[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，stdout或stderr允许传输的最大数据量（单位：字节），如果超出，子进程会被杀死。
	- `encoding`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，所有标准标准输入输出使用的编码方式（默认：`'buffer'`）。
	-  `shell`[\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，如果为`true`,则在shell中运行`command`。Unix下使用`/bin/sh`，Windows下使用`cmd.exe`。可以通过字符串指定其他shell。hell需要理解Uninx下的`-c`转换或者Windows下的/s/c`。默认为`false`（即无shell）。
- 返回值：[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
	- `pid`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，子进程的进程标识符
	- `output`[\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)，标准输出的结果数组
	- `stdout`[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，`output[1]`的内容
	- `stderr`[\<Buffer>](https://nodejs.org/dist/latest-v6.x/docs/api/buffer.html#buffer_class_buffer)|[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，`output[2]`的内容
	- `status`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，子进程的退出码
	- `signal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，用于杀死子进程的信号
	- `error`[\<Error>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)，子进程失败或超时情况下的错误对象。


`child_process.spawnSync()`方法与[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)大致相同，除了前者不会返回值直到子进程被完全关闭。当遇到超时，则会发送`killSignal`，该方法不会返回值直到进程完全退出。注意：如歌子进程拦截并处理`SIGTERM`信号并且不退出，父进程仍会等待直到子进程退出。

## 类：`ChildProcess`
添加于v2.2.0

`ChildProcess`类的实例是代表产生的子进程的[事件触发器](https://nodejs.org/dist/latest-v6.x/docs/api/events.html#events_class_eventemitter)。

`ChildProcess`实例一般不会直接创建，而是使用[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)、[child_process.exec()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_exec_command_options_callback)、[child_process.execFile()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_execfile_file_args_options_callback)或[child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)方法来创建`ChildProcess`实例。

### 事件：`'disconnect'`
添加于v0.7.2

`'disconnect'`事件在父进程中调用[child.disconnect()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_disconnect)方法后或在子进程中调用[process.disconnect()](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_disconnect)方法后触发。断开连接后，将不再能够发送或接收消息，并且[child.connected](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_connected)属性值为`false`。

### 事件：`'error'`
- `err`[\<Error>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error)，错误。

以下情况会触发`error`事件：
1. 进程无法产生
2. 进程无法杀死
3. 向子进程发送消息失败

注意：发生错误后，可能会触发`'exit'`事件也有可能不会。如果你同时监听了`'exit'`和`'error'`事件，防止意外多次调用事件处理函数是很重要的。

另请参阅[child.kill()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_kill_signal)和[child.send()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_send_message_sendhandle_options_callback)

### 事件：`'exit'`
添加于v0.1.90
- `code`[\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，子进程自行退出时的退出码
- `signal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)，终止子进程的信号

`'exit'`事件在子进程结束后触发。如果进程退出，`code`是进程的最后退出码，否则为`null`。如果进程由于收到信号而终止，`signal`是信号的字符串名，否则为`null`。两者必有其一为非空。

注意：当`'exit'`事件触发时，子进程的标准输入输出流可能仍然是开放的。

同时，注意：Node.js为`SIGINT`和`SIGTERM`建立信号处理器，并且Node.js进程不会因为接收到这些信号而立即终止，相反，Node.js将执行一系列的清理操作，然后再次触发处理信号。

查看[waitpid(2)](http://man7.org/linux/man-pages/man2/waitpid.2.html)。

### 事件：`'message'`
添加于v0.5.9
- `message`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)，解析后的JSON对象或原始值
- `sendHandle`[\<Handle>](https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_server_listen_handle_backlog_callback)，[net.Socket](https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_class_net_socket)或[net.Server](https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_class_net_server)对象，或者`undefined`。

`'message'`事件在子进程使用[process.send()](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_send_message_sendhandle_options_callback)发送消息时触发。

### `child.connected`
添加于v0.7.2
- [\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)，调用`child.disconnect()`后设置为'false'

`child.connected`属性表示是否还能够向子进程发送或从子进程接收消息。若`child.connected`为`false`，则不能再发送或接收消息。

### `child.disconnect()`
添加于v0.7.2

 关闭父进程与子进程之间的IPC通道，允许子进程在没有其他连接保持其活着时优雅地退出。调用该方法后，父进程和子进程中的`child.connected`和`process.connected`属性都会被设置为`false`，并且不能继续在进程间传递消息。
 
 当进程中没有要接收的消息时，`'disconnect'`事件被触发。大多数情况是在调用`child.disconnect()`后立即被触发。
 
 注意：当子进程是一个Node.js实例（如：使用[child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)产生），`process.disconnect()`方法也可以在子进程中被调用来关闭IPC通道。
 
 ### `child.kill([signal])`
 添加于v0.1.90
 - `signal`[\<String>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)

`child.kill()`方法向子进程发送一个信号。如果没有给出参数，会向进程发送`SIGTERM`信号。查看`signal(7)`获取可用的信号列表。

```js
const spawn = require('child_process').spawn;
const grep = spawn('grep', ['ssh']);

grep.on('close', (code, signal) => {
  console.log(
    `child process terminated due to receipt of signal ${signal}`);
});

// Send SIGHUP to process
grep.kill('SIGHUP');
```

如果信号无法送达，[ChildProcess](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process)对象将触发一个[`error`](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_event_error)事件。向一个已经退出的进程发送信号不是一个错误，但是可能会有无法预见的后果。特别地，如果进程标识符（PID）已经重新分配给了另一个进程，信号将会发送到该进程，这可能会产生意外的结果。

注意：尽管该函数叫`kill`，发送到子进程的信号实际上可能不会终止进程。

查看[kill(2)](http://man7.org/linux/man-pages/man2/kill.2.html)参考。

同样，注意：在Linux下，在企图杀死父进程时，子进程的子进程不会被终止。这种情况可能发生于在shell中运行一个新进程或者使用`ChildProcess`的`shell`选项，如下例所示：
```js
'use strict';
const spawn = require('child_process').spawn;

let child = spawn('sh', ['-c',
  `node -e "setInterval(() => {
      console.log(process.pid, 'is alive')
    }, 500);"`
  ], {
    stdio: ['inherit', 'inherit', 'inherit']
  });

setTimeout(() => {
  child.kill(); // does not terminate the node process in the shell
}, 2000);
```

### `child.pid`
添加于v0.1.90
- [\<Number>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)，整数

返回子进程的进程标识符（PID）

例：
```js
const spawn = require('child_process').spawn;
const grep = spawn('grep', ['ssh']);

console.log(`Spawned child pid: ${grep.pid}`);
grep.stdin.end();
```

`child.send(message[, sendHandle[, options]][, callback])`
添加于v0.5.9
- `message`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
- `sendHandle`[\<Handle>](https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_server_listen_handle_backlog_callback)
- `options`[\<Object>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)
- `callback`[\<Function>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function)
- 返回值：[\<Boolean>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)

当父进程和子进程之间已经建立了IPC通道（即，当使用[child_process.fork()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_fork_modulepath_args_options)）。可以使用`child.send()`方法向子进程发送消息。若子进程是一个Node.js实例，可以通过[process.on('message')(https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_message)]事件来接收这些消息。

例如：在父进程脚本中：
```js
const cp = require('child_process');
const n = cp.fork(`${__dirname}/sub.js`);

n.on('message', (m) => {
  console.log('PARENT got message:', m);
});

n.send({ hello: 'world' });
```
子进程脚本中，`'sub.js'`可能像这样：
```js
process.on('message', (m) => {
  console.log('CHILD got message:', m);
});

process.send({ foo: 'bar' });
```

子Node.js进程自己拥有[process.send()](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_process_send_message_sendhandle_options_callback)方法，使得子进程可以向父进程回送消息。

在发送一个`{cmd:'NODE_foo'}`消息时，有一个特例。所有在`cmd`属性上都包含一个`NODE_`前缀的消息，都被认为是保留在Node.js核心内使用的，并且不会再子进程的[process.on('message')](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_message)事件中触发。相反，这种消息使用`process.on('internalMessage')`事件来触发，并被Node.js内部消耗。应用应该避免使用这种消息或监听`internalMessage`事件，因为它可以不经通知自行改变。

可选的能发送到`child.send()`的`sendHandle`参数用于将一个TCP服务器或套接字对象发送到子进程。子进程接收对象作为第二参数传递给注册于[process.on('message')](https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_event_message)事件上的回调函数。套接字上接收或缓存的任何数据都不会发送到子进程。

如果给出`options`参数，则是一个用于参数化发送特定类型句柄的对象。`options`支持下列属性：
- `keepOpen`- 布尔值，可以在传送`net.Socket`实例时使用。如果为`true`，在发送过程中，套接字保持开放。默认为`false`。

可选的`callback`是一个函数，在消息发送之后，子进程接收到之前调用。该函数带有一个信号参数（成功为`null`，失败为[Error](https://nodejs.org/dist/latest-v6.x/docs/api/errors.html#errors_class_error)对象）被调用。

如果没有提供`callback`函数，并且无法发送消息，[ChildProcess](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process)对象会触发`error`事件。例如，子进程已经退出时，便会发生这种情况。

如果通道已经关闭或者未发送的消息累积已经超过一个门限值，无法再发送更多时，`child.send()`将返回`false`。否则该方法返回`true`。`callback`函数可以用于实现流量控制。

#### 案例：发送一个服务器对象
可以使用`sendHandle`参数，如下例所示，向子进程发送一个TCP服务器对象的句柄：
```js
const child = require('child_process').fork('child.js');

// Open up the server object and send the handle.
const server = require('net').createServer();
server.on('connection', (socket) => {
  socket.end('handled by parent');
});
server.listen(1337, () => {
  child.send('server', server);
});
```

子进程将收到的服务器对象如下：
```js
process.on('message', (m, server) => {
  if (m === 'server') {
    server.on('connection', (socket) => {
      socket.end('handled by child');
    });
  }
});
```

一旦父进程与子进程之间共享服务器，一些连接可以由父进程来处理，另一些可以由子进程来处理。

尽管上面的例子使用的是`net`模块创建的服务器，`dgram`模块服务器使用相同的工作流，除了监听的是`message`事件而不是`connection`事件，和使用`server.bind()`替代`server.listen()`。然而，目前这只在UNIX平台下支持。

#### 案例：发送一个套接字对象
同样的，`sendHandler`参数可以用来向子进程发送一个套接字的句柄。下例产生了两个子进程，每个句柄处理带有`"normal"`或`"special"`属性的连接：
```js
const normal = require('child_process').fork('child.js', ['normal']);
const special = require('child_process').fork('child.js', ['special']);

// Open up the server and send sockets to child
const server = require('net').createServer();
server.on('connection', (socket) => {

  // If this is special priority
  if (socket.remoteAddress === '74.125.127.100') {
    special.send('socket', socket);
    return;
  }
  // This is normal priority
  normal.send('socket', socket);
});
server.listen(1337);
```

`child.js`将接收套接字句柄作为第二个参数传递到事件回调函数：
```js
process.on('message', (m, socket) => {
  if (m === 'socket') {
    socket.end(`Request handled with ${process.argv[2]} priority`);
  }
});
```

一旦套接字被传递给子进程，父进程将不再能够追踪套接字何时被销毁。为了表示这个，`.connection`属性变为`null`。当发生该情况时，建议不要使用`.maxConnections`。

注意：该函数内部使用[JSON.stringify()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify)来序列号`message`。

### `child.stderr`
添加于v0.1.90
- [\<Stream>](https://nodejs.org/dist/latest-v6.x/docs/api/stream.html#stream_stream)

代表子进程的`stderr`的可读流。

如果子进程产生时，`stdio[2]`被设置为`pipe`以外的其他任何值，则该值为`undefined`。

`child.stderr`是`child.stdio[2]`的别名。两个属性都指向相同的值。

### `child.stdin`
添加于v0.1.90
- [\<Stream>](https://nodejs.org/dist/latest-v6.x/docs/api/stream.html#stream_stream)

代表子进程的`stdin`的可写流。

注意：如果子进程等待读它的所有输入，子进程不会继续直到该流已经通过`end()`被关闭。

如果子进程产生时，`stdio[0]`被设置为`pipe`以外的其他任何值，则该值为`undefined`。

`child.stdein`是`child.stdio[0]`的别名。两个属性都指向相同的值。

### `child.stdio`
添加于v0.7.10
- [\<Array>](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)

子进程管道的稀疏数组，与传递给已经设置了`pipe`值的[child_process.spawn()](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_child_process_spawn_command_args_options)的[stdio](https://nodejs.org/dist/latest-v6.x/docs/api/child_process.html#child_process_options_stdio)选项里的位置对应。注意：`child.stdio[0]`，`[child.stdio[1]]`和`[child.stdio[2]]`同样也可以分别用`child.stdin`，`child.stdout`和`child.stderr`来使用。

下例中，只有子进程的fd`1`(stdout)被配置为管道，所以只有父进程的`child.stdio[1]`是流，数组里的其他值都为`null`：
```js
const assert = require('assert');
const fs = require('fs');
const child_process = require('child_process');

const child = child_process.spawn('ls', {
    stdio: [
      0, // Use parents stdin for child
      'pipe', // Pipe child's stdout to parent
      fs.openSync('err.out', 'w') // Direct child's stderr to a file
    ]
});

assert.equal(child.stdio[0], null);
assert.equal(child.stdio[0], child.stdin);

assert(child.stdout);
assert.equal(child.stdio[1], child.stdout);

assert.equal(child.stdio[2], null);
assert.equal(child.stdio[2], child.stderr);
```

### `child.stdout`
添加于v0.1.90
- [\<Stream>](https://nodejs.org/dist/latest-v6.x/docs/api/stream.html#stream_stream)

代表子进程的`stdout`的可读流。

如果子进程产生时，`stdio[1]`被设置为`pipe`以外的其他任何值，则该值为`undefined`。

`child.stdeout`是`child.stdio[1]`的别名。两个属性都指向相同的值。

## maxBuffer和Unicode
重要的是要记住`maxBuffer`选项指定`stdout`或`stderr`允许的最大八位字节数。如果值超出了，则子进程被终止。这对输出包含多字节字符编码（如UTF-8或UTF-16）的尤其有影响。如，下例会输出13个UTF-8编码的八位字节数，尽管只有四个字符：
```js
console.log('中文测试');
```
